version: 2.1

jobs:
  deploy-nodeapp:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout

      # CircleCIã«ç™»éŒ²ã—ãŸSSHéµã‚’ä½¿ç”¨ï¼ˆFingerprintã§æŒ‡å®šï¼‰
      - add_ssh_keys:
          fingerprints:
            - "SHA256:xxKOKDhqcEfxkek9slpnuS4mDrXaNRPC2eMjq1oXNBk"

      # ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã‚µãƒ¼ãƒã® known_hosts ç™»éŒ²
      - run:
          name: Register known_hosts
          command: |
            mkdir -p ~/.ssh
            ssh-keyscan 163.43.218.53 >> ~/.ssh/known_hosts

      # Nodeã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼†èµ·å‹•
      - run:
          name: Deploy & start node app
          command: |
            ssh -p 22 ubuntu@163.43.218.53 "
              set -eo pipefail

              APP_DIR=/home/ubuntu/nodeapp
              REPO_URL=https://github.com/h-kameda-sakura/apitest.git

              # å¿…è¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
              if command -v apt-get >/dev/null 2>&1; then
                sudo apt-get update -y
                sudo apt-get install -y git curl
              elif command -v dnf >/dev/null 2>&1; then
                sudo dnf install -y git curl
              elif command -v yum >/dev/null 2>&1; then
                sudo yum install -y git curl
              elif command -v zypper >/dev/null 2>&1; then
                sudo zypper -n install git curl
              fi

              # GitHubã‚’known_hostsã«è¿½åŠ 
              mkdir -p ~/.ssh
              ssh-keyscan github.com >> ~/.ssh/known_hosts || true

              # Node.jsï¼ˆæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã®ã¿ï¼‰
              if ! command -v node >/dev/null 2>&1; then
                if command -v apt-get >/dev/null 2>&1; then
                  curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
                  sudo apt-get install -y nodejs
                elif command -v dnf >/dev/null 2>&1; then
                  curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
                  sudo dnf install -y nodejs
                elif command -v yum >/dev/null 2>&1; then
                  curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
                  sudo yum install -y nodejs
                elif command -v zypper >/dev/null 2>&1; then
                  curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
                  sudo zypper -n install nodejs
                else
                  echo Unsupported OS >&2; exit 1
                fi
              fi

              # åˆå›žã‚¯ãƒ­ãƒ¼ãƒ³ or æ›´æ–°
              if [ -d \"\$APP_DIR/.git\" ]; then
                git -C \"\$APP_DIR\" fetch --all
                git -C \"\$APP_DIR\" checkout main
                git -C \"\$APP_DIR\" pull --ff-only
              else
                sudo mkdir -p \"\$APP_DIR\"
                sudo chown -R ubuntu:ubuntu \"\$APP_DIR\"
                git clone \"\$REPO_URL\" \"\$APP_DIR\"
              fi

              cd \"\$APP_DIR\"
              npm ci || npm install

              # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­ç½®ï¼ˆãƒªãƒã‚¸ãƒˆãƒªã«nodeapp.serviceãŒã‚ã‚‹å‰æï¼‰
              if [ -f nodeapp.service ]; then
                sudo install -m 0644 nodeapp.service /etc/systemd/system/nodeapp.service
                sudo systemctl daemon-reload
                sudo systemctl enable nodeapp
              fi

              # ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•
              sudo systemctl restart nodeapp || sudo systemctl start nodeapp
              sudo systemctl status nodeapp --no-pager || true
            "

      # ðŸ” HTTPãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆä¸€åº¦ã ã‘å®Ÿè¡Œï¼‰
      - run:
          name: Health check http://163.43.218.53:8080/
          command: |
            URL="http://163.43.218.53:8080/"
            echo "Waiting 3 seconds before health check..."
            sleep 3
            code=$(curl -fsS -o /dev/null -w "%{http_code}" --connect-timeout 3 "$URL" || true)
            if [ "$code" = "200" ]; then
              echo "OK: $URL returned 200"
              exit 0
            else
              echo "Health check failed for $URL (status:$code)" >&2
              exit 1
            fi

workflows:
  deploy:
    jobs:
      - deploy-nodeapp
