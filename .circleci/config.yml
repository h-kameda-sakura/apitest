- run:
    name: Deploy & start node app (heredoc, no quoting hell)
    command: |
      ssh -p 22 ubuntu@27.133.130.141 'bash -s' <<'REMOTE_SCRIPT'
      set -eo pipefail

      APP_DIR=/home/ubuntu/nodeapp
      REPO_URL=git@github.com:h-kameda-sakura/apitest.git   # ← このままでOK（SSH鍵でclone）

      # 必要パッケージ & GitHub known_hosts
      if command -v apt-get >/dev/null 2>&1; then
        sudo apt-get update -y
        sudo apt-get install -y git curl
      elif command -v dnf >/dev/null 2>&1; then
        sudo dnf install -y git curl
      elif command -v yum >/dev/null 2>&1; then
        sudo yum install -y git curl
      elif command -v zypper >/dev/null 2>&1; then
        sudo zypper -n install git curl
      fi
      mkdir -p ~/.ssh
      ssh-keyscan github.com >> ~/.ssh/known_hosts || true

      # Node.js（未インストール時のみ）
      if ! command -v node >/dev/null 2>&1; then
        if command -v apt-get >/dev/null 2>&1; then
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
        elif command -v dnf >/dev/null 2>&1; then
          curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
          sudo dnf install -y nodejs
        elif command -v yum >/dev/null 2>&1; then
          curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
          sudo yum install -y nodejs
        elif command -v zypper >/dev/null 2>&1; then
          curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
          sudo zypper -n install nodejs
        else
          echo "Unsupported OS" >&2; exit 1
        fi
      fi

      # 初回クローン or 更新
      if [ -d "$APP_DIR/.git" ]; then
        git -C "$APP_DIR" fetch --all
        git -C "$APP_DIR" checkout main
        git -C "$APP_DIR" pull --ff-only
      else
        sudo mkdir -p "$APP_DIR"
        sudo chown -R ubuntu:ubuntu "$APP_DIR"
        git clone "$REPO_URL" "$APP_DIR"
      fi

      cd "$APP_DIR"
      npm ci || npm install

      # リポジトリに nodeapp.service を置いてある前提で設置
      if [ -f nodeapp.service ]; then
        sudo install -m 0644 nodeapp.service /etc/systemd/system/nodeapp.service
        sudo systemctl daemon-reload
        sudo systemctl enable nodeapp
      fi

      sudo systemctl restart nodeapp
      sudo systemctl status nodeapp --no-pager
      REMOTE_SCRIPT
