version: 2.1

jobs:
  install-node:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout

      # CircleCIに登録したSSH鍵を使用（Fingerprintで指定）
      - add_ssh_keys:
          fingerprints:
            - "SHA256:DvKOKDhqcEfxkek9slpnuS4mDrXaNRPC2eMjq1oXNBk"

      # known_hosts 登録
      - run:
          name: Register known_hosts
          command: |
            mkdir -p ~/.ssh
            ssh-keyscan -p 22 27.133.130.141 >> ~/.ssh/known_hosts

      # Node.js インストール
      - run:
          name: Install Node.js
          command: |
            ssh -p 22 ubuntu@27.133.130.141 'bash -euxo pipefail -c "
              if command -v apt-get >/dev/null 2>&1; then
                sudo apt-get update -y
                curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
                sudo apt-get install -y nodejs
              elif command -v dnf >/dev/null 2>&1; then
                sudo dnf install -y curl
                curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
                sudo dnf install -y nodejs
              elif command -v yum >/dev/null 2>&1; then
                sudo yum install -y curl
                curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
                sudo yum install -y nodejs
              elif command -v zypper >/dev/null 2>&1; then
                sudo zypper -n install curl
                curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
                sudo zypper -n install nodejs
              else
                echo \"Unsupported OS\" >&2
                exit 1
              fi
              node -v
              npm -v
            "'

workflows:
  deploy:
    jobs:
      - install-node
