version: 2.1

jobs:
  deploy-nodeapp:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout

      # CircleCIに登録したSSH鍵を使用（Fingerprintで指定）
      - add_ssh_keys:
          fingerprints:
            - "SHA256:xxKOKDhqcEfxkek9slpnuS4mDrXaNRPC2eMjq1oXNBk"

      # デプロイ先サーバの known_hosts 登録
      - run:
          name: Register known_hosts
          command: |
            mkdir -p ~/.ssh
            ssh-keyscan 163.43.218.53 >> ~/.ssh/known_hosts

      # Nodeアプリのデプロイ＆起動
      - run:
          name: Deploy & start node app
          command: |
            ssh -p 22 ubuntu@163.43.218.53 "
              set -eo pipefail

              APP_DIR=/home/ubuntu/nodeapp
              REPO_URL=https://github.com/h-kameda-sakura/apitest.git

              # 必要パッケージ
              if command -v apt-get >/dev/null 2>&1; then
                sudo apt-get update -y
                sudo apt-get install -y git curl
              elif command -v dnf >/dev/null 2>&1; then
                sudo dnf install -y git curl
              elif command -v yum >/dev/null 2>&1; then
                sudo yum install -y git curl
              elif command -v zypper >/dev/null 2>&1; then
                sudo zypper -n install git curl
              fi

              # GitHubをknown_hostsに追加
              mkdir -p ~/.ssh
              ssh-keyscan github.com >> ~/.ssh/known_hosts || true

              # Node.js（未インストール時のみ）
              if ! command -v node >/dev/null 2>&1; then
                if command -v apt-get >/dev/null 2>&1; then
                  curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
                  sudo apt-get install -y nodejs
                elif command -v dnf >/dev/null 2>&1; then
                  curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
                  sudo dnf install -y nodejs
                elif command -v yum >/dev/null 2>&1; then
                  curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
                  sudo yum install -y nodejs
                elif command -v zypper >/dev/null 2>&1; then
                  curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
                  sudo zypper -n install nodejs
                else
                  echo Unsupported OS >&2; exit 1
                fi
              fi

              # 初回クローン or 更新
              if [ -d \"\$APP_DIR/.git\" ]; then
                git -C \"\$APP_DIR\" fetch --all
                git -C \"\$APP_DIR\" checkout main
                git -C \"\$APP_DIR\" pull --ff-only
              else
                sudo mkdir -p \"\$APP_DIR\"
                sudo chown -R ubuntu:ubuntu \"\$APP_DIR\"
                git clone \"\$REPO_URL\" \"\$APP_DIR\"
              fi

              cd \"\$APP_DIR\"
              npm ci || npm install

              # ユニットファイルを設置（リポジトリにnodeapp.serviceがある前提）
              if [ -f nodeapp.service ]; then
                sudo install -m 0644 nodeapp.service /etc/systemd/system/nodeapp.service
                sudo systemctl daemon-reload
                sudo systemctl enable nodeapp
              fi

              # サービス再起動
              sudo systemctl restart nodeapp || sudo systemctl start nodeapp
              sudo systemctl status nodeapp --no-pager || true
            "

      # 🔍 HTTPヘルスチェック（一度だけ実行）
      - run:
          name: Health check http://163.43.218.53:8080/
          command: |
            URL="http://163.43.218.53:8080/"
            echo "Waiting 3 seconds before health check..."
            sleep 3
            code=$(curl -fsS -o /dev/null -w "%{http_code}" --connect-timeout 3 "$URL" || true)
            if [ "$code" = "200" ]; then
              echo "OK: $URL returned 200"
              exit 0
            else
              echo "Health check failed for $URL (status:$code)" >&2
              exit 1
            fi

workflows:
  deploy:
    jobs:
      - deploy-nodeapp
